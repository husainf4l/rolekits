{% extends "base.html" %}

{% block title %}CV Builder - Rolekits{% endblock %}

{% block nav_links %}
<a href="/dashboard" class="text-gray-700 hover:text-black px-3 py-2 rounded-md text-sm font-medium transition-colors duration-300">Dashboard</a>
<span class="text-gray-700 px-3 py-2 text-sm font-medium">Welcome, <span id="username">User</span></span>
<button onclick="logout()" class="text-gray-700 hover:text-black px-4 py-2 rounded-md text-sm font-medium transition-colors duration-300">Logout</button>
{% endblock %}

{% block content %}
<div class="w-full py-6 px-4 sm:px-6 lg:px-8">
    <!-- Header Section -->
    <div class="mb-8 text-center">
        <h1 class="text-3xl font-light text-gray-900 mb-4 tracking-tight">Create your professional CV with intelligent assistance</h1>
    </div>

    <!-- Main Content Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 h-[calc(100vh-200px)]">
            <!-- Left Side: Chat Interface -->
            <div class="bg-white/80 backdrop-blur-sm rounded-2xl shadow-xl border border-white/20 flex flex-col overflow-hidden">
                <!-- Chat Header -->
                <div class="bg-gradient-to-r from-indigo-600 via-purple-600 to-blue-600 text-white px-4 py-3">
                    <div class="flex items-center space-x-4">
                        <div class="w-8 h-8 bg-white/20 rounded-full flex items-center justify-center backdrop-blur-sm">
                        </div>
                        <div>
                            <h2 class="text-lg font-bold">AI Assistant</h2>
                            <p class="text-indigo-100 text-sm">Your personal CV crafting companion</p>
                        </div>
                    </div>
                </div>

                <!-- Chat Messages -->
                <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-4 bg-gradient-to-b from-gray-50/50 to-white/50">
                    <!-- Initial AI Message -->
                    <div class="flex items-start space-x-4 animate-fade-in">
                        <div class="flex-shrink-0">
                            <div class="w-8 h-8 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-full flex items-center justify-center shadow-lg">
                            </div>
                        </div>
                        <div class="flex-1">
                            <div class="bg-white rounded-2xl p-4 shadow-lg border border-gray-100">
                                <p class="text-gray-800 font-medium mb-4">ðŸ‘‹ Hello! I'm your AI CV assistant. I can help you build your CV by understanding natural language. Try telling me about your work experience, education, skills, or contact information. Use the quick action buttons below for examples!</p>
                                <div class="bg-gradient-to-r from-indigo-50 to-purple-50 rounded-xl p-4 border border-indigo-100">
                                    <p class="text-gray-700 mb-3 font-medium">To get started, tell me about:</p>
                                    <ul class="space-y-2 text-gray-600">
                                        <li class="flex items-center space-x-2">
                                            <div class="w-2 h-2 bg-indigo-500 rounded-full"></div>
                                            <span>Your professional background and experience</span>
                                        </li>
                                        <li class="flex items-center space-x-2">
                                            <div class="w-2 h-2 bg-purple-500 rounded-full"></div>
                                            <span>Key achievements and skills</span>
                                        </li>
                                        <li class="flex items-center space-x-2">
                                            <div class="w-2 h-2 bg-blue-500 rounded-full"></div>
                                            <span>Your education and qualifications</span>
                                        </li>
                                    </ul>
                                    <p class="text-gray-600 text-sm mt-3">ðŸ’¡ <strong>Tip:</strong> Your CV data is automatically saved and synced. Use the quick action buttons below or type your information naturally!</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Chat Input -->
                <div class="border-t border-gray-200 p-4 bg-white/50 backdrop-blur-sm">
                    <form id="chat-form" class="space-y-4">
                        <div class="flex space-x-3">
                            <div class="flex-1 relative">
                                <input
                                    type="text"
                                    id="chat-input"
                                    placeholder="Tell me about your experience, skills, or what you'd like to add to your CV..."
                                    class="w-full px-4 py-3 border-2 border-gray-200 rounded-2xl focus:outline-none focus:border-indigo-500 focus:ring-4 focus:ring-indigo-500/20 transition-all duration-200 text-gray-700 placeholder-gray-400"
                                    required
                                />
                            </div>
                            <button
                                type="submit"
                                class="bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white px-6 py-3 rounded-2xl transition-all duration-200 shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 font-semibold"
                            >
                            </button>
                        </div>
                        <div class="flex flex-wrap gap-3">
                            <button type="button" onclick="quickAction('Add work experience')" class="px-4 py-2 bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white text-sm rounded-full transition-all duration-200 shadow-md hover:shadow-lg transform hover:-translate-y-0.5">
                                + Work Experience
                            </button>
                            <button type="button" onclick="quickAction('Add education')" class="px-4 py-2 bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white text-sm rounded-full transition-all duration-200 shadow-md hover:shadow-lg transform hover:-translate-y-0.5">
                                + Education
                            </button>
                            <button type="button" onclick="quickAction('Add skills')" class="px-4 py-2 bg-gradient-to-r from-purple-500 to-purple-600 hover:from-purple-600 hover:to-purple-700 text-white text-sm rounded-full transition-all duration-200 shadow-md hover:shadow-lg transform hover:-translate-y-0.5">
                                + Skills
                            </button>
                            <button type="button" onclick="quickAction('Add projects')" class="px-4 py-2 bg-gradient-to-r from-orange-500 to-orange-600 hover:from-orange-600 hover:to-orange-700 text-white text-sm rounded-full transition-all duration-200 shadow-md hover:shadow-lg transform hover:-translate-y-0.5">
                                + Projects
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Right Side: CV Preview -->
            <div class="bg-white/80 backdrop-blur-sm rounded-2xl shadow-xl border border-white/20 overflow-hidden flex flex-col">
                <!-- CV Preview Header -->
                <div class="bg-gradient-to-r from-gray-900 to-gray-800 text-white px-4 py-3 flex justify-between items-center">
                    <div class="flex items-center space-x-3">
                        <div class="w-6 h-6 bg-white/20 rounded-lg flex items-center justify-center">
                        </div>
                        <div>
                            <h2 class="text-lg font-bold">Live Preview</h2>
                            <p class="text-gray-300 text-sm">Your CV updates in real-time</p>
                            <p class="text-gray-400 text-xs mt-1">CV ID: <span id="cv-id-display">Loading...</span></p>
                        </div>
                    </div>
                    <div class="flex space-x-3">
                        <button onclick="saveCV()" class="bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white px-4 py-2 rounded-xl transition-all duration-200 shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 font-semibold flex items-center space-x-2">
                            Save
                        </button>
                        <button onclick="downloadCV()" class="bg-gradient-to-r from-red-500 to-pink-600 hover:from-red-600 hover:to-pink-700 text-white px-4 py-2 rounded-xl transition-all duration-200 shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 font-semibold flex items-center space-x-2">
                            PDF
                        </button>
                    </div>
                </div>

                <!-- CV Content -->
                <div id="cv-preview" class="flex-1 overflow-y-auto p-6 bg-gradient-to-b from-white to-gray-50/50">
                    <!-- Personal Information -->
                    <div id="personal-info" class="mb-6">
                        <div class="text-center mb-4">
                            <h1 id="cv-name" class="text-3xl font-bold bg-gradient-to-r from-gray-900 to-gray-700 bg-clip-text text-transparent mb-3">Your Name</h1>
                            <div class="flex justify-center items-center space-x-4 text-gray-600">
                                <div class="flex items-center space-x-2">
                                    <span id="cv-email" class="hover:text-indigo-600 transition-colors">email@example.com</span>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <span id="cv-phone" class="hover:text-green-600 transition-colors">+1 (555) 123-4567</span>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <span id="cv-location" class="hover:text-blue-600 transition-colors">City, Country</span>
                                </div>
                            </div>
                            <div class="mt-3 flex justify-center space-x-4">
                                <a id="cv-linkedin" href="#" class="text-gray-600 hover:text-blue-600 transition-colors hidden flex items-center space-x-2">
                                    LinkedIn
                                </a>
                                <a id="cv-github" href="#" class="text-gray-600 hover:text-gray-800 transition-colors hidden flex items-center space-x-2">
                                    GitHub
                                </a>
                                <a id="cv-website" href="#" class="text-gray-600 hover:text-purple-600 transition-colors hidden flex items-center space-x-2">
                                    Website
                                </a>
                            </div>
                        </div>
                    </div>

                    <!-- Professional Summary -->
                    <div id="summary-section" class="mb-6 hidden">
                        <div class="border-l-4 border-indigo-500 pl-4">
                            <h2 class="text-xl font-bold text-gray-900 mb-3 flex items-center">
                                Professional Summary
                            </h2>
                            <p id="cv-summary" class="text-gray-700 leading-relaxed text-base">Your professional summary will appear here...</p>
                        </div>
                    </div>

                    <!-- Work Experience -->
                    <div id="experience-section" class="mb-6 hidden">
                        <div class="border-l-4 border-blue-500 pl-4">
                            <h2 class="text-xl font-bold text-gray-900 mb-4 flex items-center">
                                Work Experience
                            </h2>
                            <div id="cv-experience" class="space-y-4">
                                <!-- Experience items will be added dynamically -->
                            </div>
                        </div>
                    </div>

                    <!-- Education -->
                    <div id="education-section" class="mb-6 hidden">
                        <div class="border-l-4 border-green-500 pl-4">
                            <h2 class="text-xl font-bold text-gray-900 mb-4 flex items-center">
                                Education
                            </h2>
                            <div id="cv-education" class="space-y-4">
                                <!-- Education items will be added dynamically -->
                            </div>
                        </div>
                    </div>

                    <!-- Skills -->
                    <div id="skills-section" class="mb-6 hidden">
                        <div class="border-l-4 border-purple-500 pl-4">
                            <h2 class="text-xl font-bold text-gray-900 mb-4 flex items-center">
                                Skills
                            </h2>
                            <div id="cv-skills" class="flex flex-wrap gap-2">
                                <!-- Skills will be added dynamically -->
                            </div>
                        </div>
                    </div>

                    <!-- Languages -->
                    <div id="languages-section" class="mb-6 hidden">
                        <div class="border-l-4 border-orange-500 pl-4">
                            <h2 class="text-xl font-bold text-gray-900 mb-4 flex items-center">
                                Languages
                            </h2>
                            <div id="cv-languages" class="space-y-3">
                                <!-- Languages will be added dynamically -->
                            </div>
                        </div>
                    </div>

                    <!-- Certifications -->
                    <div id="certifications-section" class="mb-6 hidden">
                        <div class="border-l-4 border-red-500 pl-4">
                            <h2 class="text-xl font-bold text-gray-900 mb-4 flex items-center">
                                Certifications
                            </h2>
                            <div id="cv-certifications" class="space-y-3">
                                <!-- Certifications will be added dynamically -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
@keyframes fade-in {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.animate-fade-in {
    animation: fade-in 0.5s ease-out;
}

.gradient-text {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}
</style>

<script>
// CV Data Store
let cvData = {
    id: null,
    full_name: "Your Name",
    email: "email@example.com",
    phone: "+1 (555) 123-4567",
    address: "City, Country",
    linkedin: "",
    github: "",
    website: "",
    summary: "",
    experience: [],
    education: [],
    skills: [],
    languages: [],
    certifications: []
};

// Track last update time for subscription handling
let lastUpdateTime = null;

// GraphQL client
async function graphqlQuery(query, variables = {}) {
    const token = localStorage.getItem('access_token');
    const response = await fetch('/graphql', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({ query, variables })
    });
    
    const result = await response.json();
    if (result.errors) {
        console.error('GraphQL errors:', result.errors);
        throw new Error(result.errors[0].message);
    }
    return result.data;
}

// Server-Sent Events connection for real-time updates
let eventSource = null;

function connectSSE() {
    if (eventSource) {
        eventSource.close();
    }

    const token = localStorage.getItem('access_token');
    if (!token || !cvData.id) return;

    // Create EventSource connection for CV updates with token as query parameter
    const url = `/cv-updates/${cvData.id}?token=${encodeURIComponent(token)}`;
    eventSource = new EventSource(url);

    eventSource.onopen = () => {
        console.log('SSE connected');
    };

    eventSource.onmessage = (event) => {
        try {
            const data = JSON.parse(event.data);
            
            if (data.error) {
                console.error('SSE error:', data.error);
                return;
            }
            
            // Handle CV update
            handleCVUpdate(data);
        } catch (error) {
            console.error('Error parsing SSE data:', error, 'Raw data:', event.data);
        }
    };

    eventSource.onerror = (error) => {
        console.error('SSE error event:', error);
        console.error('SSE readyState:', eventSource.readyState);
        console.error('SSE url:', eventSource.url);
        // Attempt to reconnect after 5 seconds
        setTimeout(() => {
            if (cvData.id) {
                connectSSE();
            }
        }, 5000);
    };
}

function disconnectSSE() {
    if (eventSource) {
        eventSource.close();
        eventSource = null;
    }
}

function handleCVUpdate(updatedCV) {
    // Check if this is actually a new update
    const serverUpdateTime = updatedCV.updated_at ? new Date(updatedCV.updated_at).getTime() : Date.now();
    
    if (!lastUpdateTime || serverUpdateTime > lastUpdateTime) {
        // Convert snake_case to camelCase for frontend
        const convertedCV = {
            id: updatedCV.id,
            fullName: updatedCV.full_name,
            email: updatedCV.email,
            phone: updatedCV.phone,
            address: updatedCV.address,
            linkedin: updatedCV.linkedin,
            github: updatedCV.github,
            website: updatedCV.website,
            summary: updatedCV.summary,
            experience: updatedCV.experience || [],
            education: updatedCV.education || [],
            skills: updatedCV.skills || [],
            languages: updatedCV.languages || [],
            certifications: updatedCV.certifications || [],
            updatedAt: updatedCV.updated_at
        };
        
        // Update our local data with server data
        loadCVData(convertedCV, true);
        lastUpdateTime = serverUpdateTime;
        
        // Show a subtle notification
        showUpdateNotification();
    }
}

// Check authentication
async function checkAuth() {
    const token = localStorage.getItem('access_token');
    if (!token) {
        window.location.href = '/login';
        return;
    }

    try {
        const response = await fetch('/me', {
            headers: { 'Authorization': `Bearer ${token}` }
        });

        if (response.ok) {
            const data = await response.json();
            document.getElementById('username').textContent = data.username;
            // Load user's CVs
            await loadUserCVs();
            // SSE connection will be established by loadCVData() when CV is loaded
        } else {
            localStorage.removeItem('access_token');
            window.location.href = '/login';
        }
    } catch (error) {
        window.location.href = '/login';
    }
}

// Load user's CVs
async function loadUserCVs() {
    try {
        const query = `
            query {
                myCvs {
                    id
                    fullName
                    email
                    phone
                    address
                    linkedin
                    github
                    website
                    summary
                    experience {
                        company
                        position
                        startDate
                        endDate
                        description
                        location
                    }
                    education {
                        institution
                        degree
                        fieldOfStudy
                        startDate
                        endDate
                        grade
                        description
                    }
                    skills
                    languages {
                        language
                        proficiency
                    }
                    certifications {
                        name
                        issuingOrganization
                        issueDate
                        expiryDate
                        credentialId
                        credentialUrl
                    }
                }
            }
        `;
        
        const data = await graphqlQuery(query);
        const cvs = data.myCvs;
        
        if (cvs && cvs.length > 0) {
            // Load the most recent CV
            const latestCV = cvs[cvs.length - 1];
            loadCVData(latestCV);
        } else {
            // No CVs exist yet, show new CV state
            document.getElementById('cv-id-display').textContent = 'New CV';
            // Start SSE connection will be called when CV is created
        }
    } catch (error) {
        console.error('Error loading CVs:', error);
        // Continue with empty CV for new users
    }
}

// Load CV data into the interface
function loadCVData(cv, fromSSE = false) {
    cvData.id = cv.id;
    cvData.full_name = cv.fullName || "Your Name";
    cvData.email = cv.email || "email@example.com";
    cvData.phone = cv.phone || "+1 (555) 123-4567";
    cvData.address = cv.address || "City, Country";
    cvData.linkedin = cv.linkedin || "";
    cvData.github = cv.github || "";
    cvData.website = cv.website || "";
    cvData.summary = cv.summary || "";
    cvData.experience = (cv.experience || []).map(exp => ({
        company: exp.company,
        position: exp.position,
        start_date: exp.startDate,
        end_date: exp.endDate,
        description: exp.description,
        location: exp.location
    }));
    cvData.education = (cv.education || []).map(edu => ({
        institution: edu.institution,
        degree: edu.degree,
        field_of_study: edu.fieldOfStudy,
        start_date: edu.startDate,
        end_date: edu.endDate,
        grade: edu.grade,
        description: edu.description
    }));
    cvData.skills = cv.skills || [];
    cvData.languages = (cv.languages || []).map(lang => ({
        language: lang.language,
        proficiency: lang.proficiency
    }));
    cvData.certifications = (cv.certifications || []).map(cert => ({
        name: cert.name,
        issuing_organization: cert.issuingOrganization,
        issue_date: cert.issueDate,
        expiry_date: cert.expiryDate,
        credential_id: cert.credentialId,
        credential_url: cert.credentialUrl
    }));
    
    // Set last update time if available
    if (cv.updatedAt) {
        lastUpdateTime = new Date(cv.updatedAt).getTime();
    }
    
    // Update CV ID display
    document.getElementById('cv-id-display').textContent = cv.id || 'New CV';
    
    updateCVPreview();
    
    // Start SSE connection for real-time updates (only if not from SSE)
    if (!fromSSE) {
        connectSSE();
    }
}

// Logout function
function logout() {
    localStorage.removeItem('access_token');
    disconnectSSE();
    window.location.href = '/login';
}

// Chat functionality
document.getElementById('chat-form').addEventListener('submit', function(e) {
    e.preventDefault();

    const input = document.getElementById('chat-input');
    const message = input.value.trim();

    if (!message) return;

    // Add user message to chat
    addMessage(message, 'user');

    // Clear input
    input.value = '';

    // Process message and update CV (simplified - in production, this would call AI API)
    processMessage(message);
});

function addMessage(text, sender) {
    const messagesDiv = document.getElementById('chat-messages');
    const messageDiv = document.createElement('div');
    messageDiv.className = 'flex items-start space-x-4 animate-fade-in';

    if (sender === 'user') {
        messageDiv.innerHTML = `
            <div class="flex-1"></div>
            <div class="flex-shrink-0">
                <div class="w-8 h-8 bg-gradient-to-br from-indigo-600 to-purple-600 rounded-full flex items-center justify-center shadow-lg">
                    <span class="text-white font-semibold">You</span>
                </div>
            </div>
            <div class="max-w-md">
                <div class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-2xl p-4 shadow-lg">
                    <p>${text}</p>
                </div>
            </div>
        `;
    } else {
        messageDiv.innerHTML = `
            <div class="flex-shrink-0">
                <div class="w-8 h-8 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-full flex items-center justify-center shadow-lg">
                </div>
            </div>
            <div class="flex-1">
                <div class="bg-white rounded-2xl p-4 shadow-lg border border-gray-100">
                    <p class="text-gray-800">${text}</p>
                </div>
            </div>
        `;
    }

    messagesDiv.appendChild(messageDiv);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

function processMessage(message) {
    // Simple AI processing - in production, this would integrate with actual AI
    const lowerMessage = message.toLowerCase();
    
    // Basic pattern matching for common CV updates
    if (lowerMessage.includes('name') || lowerMessage.includes('full name')) {
        const nameMatch = message.match(/(?:my name is|name is|i am|called)\s+(.+)/i);
        if (nameMatch) {
            cvData.full_name = nameMatch[1].trim();
        }
    }
    
    if (lowerMessage.includes('email')) {
        const emailMatch = message.match(/([a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,})/);
        if (emailMatch) {
            cvData.email = emailMatch[1];
        }
    }
    
    if (lowerMessage.includes('phone') || lowerMessage.includes('number')) {
        const phoneMatch = message.match(/(\+?\d{1,3}[-.\s]?\(?\d{3}\)?[-.\s]?\d{3}[-.\s]?\d{4})/);
        if (phoneMatch) {
            cvData.phone = phoneMatch[1];
        }
    }
    
    if (lowerMessage.includes('address') || lowerMessage.includes('location') || lowerMessage.includes('city')) {
        const addressParts = message.split(/(?:address|location|city|country)/i)[1];
        if (addressParts) {
            cvData.address = addressParts.trim().replace(/^[\s,:;]+/, '');
        }
    }
    
    if (lowerMessage.includes('summary') || lowerMessage.includes('about me') || lowerMessage.includes('professional summary')) {
        const summaryMatch = message.match(/(?:summary|about me|professional summary)[\s:]*(.+)/i);
        if (summaryMatch) {
            cvData.summary = summaryMatch[1].trim();
        } else if (!cvData.summary) {
            cvData.summary = message;
        }
    }
    
    if (lowerMessage.includes('skill') || lowerMessage.includes('skills')) {
        const skillsMatch = message.match(/(?:skills?|proficient in|experienced in|know)[\s:]*(.+)/i);
        if (skillsMatch) {
            const skillsText = skillsMatch[1];
            const newSkills = skillsText.split(/[,;and]+/).map(skill => skill.trim()).filter(skill => skill.length > 0);
            cvData.skills = [...new Set([...cvData.skills, ...newSkills])];
        }
    }
    
    // Handle work experience
    if (lowerMessage.includes('work') || lowerMessage.includes('experience') || lowerMessage.includes('job') || lowerMessage.includes('position')) {
        const expMatch = message.match(/(?:worked as|worked|position|role)(?:\s+as)?\s+(.+?)\s+at\s+(.+?)(?:\s+from\s+(.+?)\s+to\s+(.+?))?(?:\s*[,.;]*(.+))?/i);
        if (expMatch) {
            const position = expMatch[1].trim();
            const company = expMatch[2].trim();
            const startDate = expMatch[3] ? parseDate(expMatch[3].trim()) : '';
            const endDate = expMatch[4] ? parseDate(expMatch[4].trim()) : '';
            const description = expMatch[5] ? expMatch[5].trim() : '';
            
            const newExperience = {
                company: company,
                position: position,
                start_date: startDate,
                end_date: endDate,
                description: description,
                location: ''
            };
            
            cvData.experience.push(newExperience);
        }
    }
    
    // Handle education
    if (lowerMessage.includes('education') || lowerMessage.includes('degree') || lowerMessage.includes('graduated') || lowerMessage.includes('studied') || lowerMessage.includes('university') || lowerMessage.includes('college')) {
        const eduMatch = message.match(/(?:graduated|studied|degree)(?:\s+with)?(?:\s+a)?\s+(.+?)\s+(?:in|from|at)\s+(.+?)(?:\s+in\s+(.+?))?(?:\s+from\s+(.+?)\s+to\s+(.+?))?(?:\s*[,.;]*(.+))?/i);
        if (eduMatch) {
            const degree = eduMatch[1].trim();
            const institution = eduMatch[2].trim();
            const fieldOfStudy = eduMatch[3] ? eduMatch[3].trim() : '';
            const startDate = eduMatch[4] ? parseDate(eduMatch[4].trim()) : '';
            const endDate = eduMatch[5] ? parseDate(eduMatch[5].trim()) : '';
            const grade = eduMatch[6] ? eduMatch[6].trim() : '';
            
            const newEducation = {
                institution: institution,
                degree: degree,
                field_of_study: fieldOfStudy,
                start_date: startDate,
                end_date: endDate,
                grade: grade,
                description: ''
            };
            
            cvData.education.push(newEducation);
        }
    }
    
    // Update the preview immediately
    updateCVPreview();
    
    // Show confirmation message
    setTimeout(() => {
        addMessage("Great! I've updated your CV with that information. The changes are reflected in the preview on the right. What would you like to add next?", 'ai');
    }, 500);
}

// Helper function to parse dates from natural language
function parseDate(dateString) {
    // Simple date parsing - could be improved
    const months = {
        'january': '01', 'february': '02', 'march': '03', 'april': '04', 'may': '05', 'june': '06',
        'july': '07', 'august': '08', 'september': '09', 'october': '10', 'november': '11', 'december': '12'
    };
    
    const monthMatch = dateString.toLowerCase().match(/(january|february|march|april|may|june|july|august|september|october|november|december)/);
    const yearMatch = dateString.match(/\b(19|20)\d{2}\b/);
    
    if (monthMatch && yearMatch) {
        const month = months[monthMatch[1].toLowerCase()];
        const year = yearMatch[0];
        return `${year}-${month}`;
    }
    
    // If only year, return year
    if (yearMatch) {
        return yearMatch[0];
    }
    
    return dateString; // Return as-is if can't parse
}

function quickAction(action) {
    let sampleMessage = '';
    
    switch(action.toLowerCase()) {
        case 'add work experience':
            sampleMessage = 'I worked as a Senior Software Engineer at Tech Innovations from January 2020 to December 2023. I led a team of 5 developers, implemented microservices architecture, and improved system performance by 40%.';
            break;
        case 'add education':
            sampleMessage = 'I graduated with a Bachelor\'s degree in Computer Science from Stanford University from September 2016 to May 2020 with a 3.8 GPA.';
            break;
        case 'add skills':
            sampleMessage = 'My skills include Python, JavaScript, React, Node.js, PostgreSQL, Docker, AWS, and Kubernetes.';
            break;
        case 'add contact info':
            sampleMessage = 'My name is John Doe, my email is john.doe@email.com, my phone number is +1 (555) 123-4567, and I live in San Francisco, CA.';
            break;
        case 'add summary':
            sampleMessage = 'I am an experienced software engineer with 5+ years in web development, specializing in Python and JavaScript technologies. I have a passion for building scalable applications and mentoring junior developers.';
            break;
        case 'add language':
            sampleMessage = 'I speak English fluently and have intermediate proficiency in Spanish.';
            break;
        case 'add certification':
            sampleMessage = 'I have an AWS Certified Solutions Architect certification issued by Amazon Web Services in March 2022, valid until March 2025.';
            break;
        default:
            sampleMessage = action;
    }
    
    document.getElementById('chat-input').value = sampleMessage;
}

function updateCVPreview() {
    // Update personal info
    document.getElementById('cv-name').textContent = cvData.full_name;
    document.getElementById('cv-email').textContent = cvData.email;
    document.getElementById('cv-phone').textContent = cvData.phone;
    document.getElementById('cv-location').textContent = cvData.address;

    // Update social links
    const linkedinLink = document.getElementById('cv-linkedin');
    const githubLink = document.getElementById('cv-github');
    const websiteLink = document.getElementById('cv-website');
    
    if (cvData.linkedin) {
        linkedinLink.href = cvData.linkedin;
        linkedinLink.classList.remove('hidden');
        linkedinLink.textContent = 'LinkedIn';
    } else {
        linkedinLink.classList.add('hidden');
    }
    
    if (cvData.github) {
        githubLink.href = cvData.github;
        githubLink.classList.remove('hidden');
        githubLink.textContent = 'GitHub';
    } else {
        githubLink.classList.add('hidden');
    }
    
    if (cvData.website) {
        websiteLink.href = cvData.website;
        websiteLink.classList.remove('hidden');
        websiteLink.textContent = 'Website';
    } else {
        websiteLink.classList.add('hidden');
    }

    // Update summary
    if (cvData.summary) {
        document.getElementById('summary-section').classList.remove('hidden');
        document.getElementById('cv-summary').textContent = cvData.summary;
    } else {
        document.getElementById('summary-section').classList.add('hidden');
    }

    // Update experience
    if (cvData.experience && cvData.experience.length > 0) {
        document.getElementById('experience-section').classList.remove('hidden');
        const experienceDiv = document.getElementById('cv-experience');
        experienceDiv.innerHTML = cvData.experience.map(exp => `
            <div class="mb-6">
                <div class="flex justify-between items-start mb-2">
                    <div>
                        <h3 class="text-lg font-semibold text-gray-900">${exp.position}</h3>
                        <p class="text-indigo-600 font-medium">${exp.company}</p>
                        ${exp.location ? `<p class="text-gray-600 text-sm">${exp.location}</p>` : ''}
                    </div>
                    <div class="text-right text-sm text-gray-600">
                        <p>${formatDate(exp.start_date)} - ${exp.end_date ? formatDate(exp.end_date) : 'Present'}</p>
                    </div>
                </div>
                ${exp.description ? `<p class="text-gray-700 text-sm leading-relaxed">${exp.description}</p>` : ''}
            </div>
        `).join('');
    } else {
        document.getElementById('experience-section').classList.add('hidden');
    }

    // Update education
    if (cvData.education && cvData.education.length > 0) {
        document.getElementById('education-section').classList.remove('hidden');
        const educationDiv = document.getElementById('cv-education');
        educationDiv.innerHTML = cvData.education.map(edu => `
            <div class="mb-6">
                <div class="flex justify-between items-start mb-2">
                    <div>
                        <h3 class="text-lg font-semibold text-gray-900">${edu.degree} in ${edu.field_of_study}</h3>
                        <p class="text-green-600 font-medium">${edu.institution}</p>
                        ${edu.grade ? `<p class="text-gray-600 text-sm">${edu.grade}</p>` : ''}
                    </div>
                    <div class="text-right text-sm text-gray-600">
                        <p>${formatDate(edu.start_date)} - ${edu.end_date ? formatDate(edu.end_date) : 'Present'}</p>
                    </div>
                </div>
                ${edu.description ? `<p class="text-gray-700 text-sm leading-relaxed">${edu.description}</p>` : ''}
            </div>
        `).join('');
    } else {
        document.getElementById('education-section').classList.add('hidden');
    }

    // Update skills
    if (cvData.skills && cvData.skills.length > 0) {
        document.getElementById('skills-section').classList.remove('hidden');
        const skillsDiv = document.getElementById('cv-skills');
        skillsDiv.innerHTML = cvData.skills.map(skill =>
            `<span class="px-3 py-1 bg-gradient-to-r from-indigo-100 to-purple-100 text-indigo-800 rounded-full text-sm font-medium shadow-sm hover:shadow-md transition-shadow duration-200">${skill}</span>`
        ).join('');
    } else {
        document.getElementById('skills-section').classList.add('hidden');
    }

    // Update languages
    if (cvData.languages && cvData.languages.length > 0) {
        document.getElementById('languages-section').classList.remove('hidden');
        const languagesDiv = document.getElementById('cv-languages');
        languagesDiv.innerHTML = cvData.languages.map(lang => `
            <div class="flex justify-between items-center py-2">
                <span class="font-medium text-gray-900">${lang.language}</span>
                <span class="text-sm text-gray-600">${lang.proficiency}</span>
            </div>
        `).join('');
    } else {
        document.getElementById('languages-section').classList.add('hidden');
    }

    // Update certifications
    if (cvData.certifications && cvData.certifications.length > 0) {
        document.getElementById('certifications-section').classList.remove('hidden');
        const certificationsDiv = document.getElementById('cv-certifications');
        certificationsDiv.innerHTML = cvData.certifications.map(cert => `
            <div class="mb-4">
                <div class="flex justify-between items-start mb-2">
                    <div>
                        <h3 class="text-lg font-semibold text-gray-900">${cert.name}</h3>
                        <p class="text-red-600 font-medium">${cert.issuing_organization}</p>
                        ${cert.credential_id ? `<p class="text-gray-600 text-sm">ID: ${cert.credential_id}</p>` : ''}
                    </div>
                    <div class="text-right text-sm text-gray-600">
                        <p>Issued: ${formatDate(cert.issue_date)}</p>
                        ${cert.expiry_date ? `<p>Expires: ${formatDate(cert.expiry_date)}</p>` : ''}
                    </div>
                </div>
                ${cert.credential_url ? `<a href="${cert.credential_url}" target="_blank" class="text-blue-600 hover:text-blue-800 text-sm">View Credential</a>` : ''}
            </div>
        `).join('');
    } else {
        document.getElementById('certifications-section').classList.add('hidden');
    }
}

// Helper function to format dates
function formatDate(dateString) {
    if (!dateString) return '';
    try {
        const date = new Date(dateString);
        return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short' });
    } catch (e) {
        return dateString;
    }
}

async function saveCV() {
    try {
        let mutation;
        let variables;
        
        if (cvData.id) {
            // Update existing CV
            mutation = `
                mutation UpdateCV($cvId: Int!, $input: CVUpdateInput!) {
                    updateCv(cvId: $cvId, input: $input) {
                        id
                        fullName
                        email
                        phone
                        address
                        linkedin
                        github
                        website
                        summary
                        skills
                        updatedAt
                    }
                }
            `;
            variables = {
                cvId: cvData.id,
                input: {
                    full_name: cvData.full_name,
                    email: cvData.email,
                    phone: cvData.phone,
                    address: cvData.address,
                    linkedin: cvData.linkedin,
                    github: cvData.github,
                    website: cvData.website,
                    summary: cvData.summary,
                    skills: cvData.skills,
                    experience: cvData.experience.map(exp => ({
                        company: exp.company,
                        position: exp.position,
                        startDate: exp.start_date,
                        endDate: exp.end_date,
                        description: exp.description,
                        location: exp.location
                    })),
                    education: cvData.education.map(edu => ({
                        institution: edu.institution,
                        degree: edu.degree,
                        fieldOfStudy: edu.field_of_study,
                        startDate: edu.start_date,
                        endDate: edu.end_date,
                        grade: edu.grade,
                        description: edu.description
                    })),
                    languages: cvData.languages.map(lang => ({
                        language: lang.language,
                        proficiency: lang.proficiency
                    })),
                    certifications: cvData.certifications.map(cert => ({
                        name: cert.name,
                        issuingOrganization: cert.issuing_organization,
                        issueDate: cert.issue_date,
                        expiryDate: cert.expiry_date,
                        credentialId: cert.credential_id,
                        credentialUrl: cert.credential_url
                    }))
                }
            };
        } else {
            // Create new CV
            mutation = `
                mutation CreateCV($input: CVInput!) {
                    createCv(input: $input) {
                        id
                        fullName
                        email
                        phone
                        address
                        linkedin
                        github
                        website
                        summary
                        skills
                        createdAt
                    }
                }
            `;
            variables = {
                input: {
                    fullName: cvData.full_name,
                    email: cvData.email,
                    phone: cvData.phone,
                    address: cvData.address,
                    linkedin: cvData.linkedin,
                    github: cvData.github,
                    website: cvData.website,
                    summary: cvData.summary,
                    skills: cvData.skills,
                    experience: cvData.experience.map(exp => ({
                        company: exp.company,
                        position: exp.position,
                        startDate: exp.start_date,
                        endDate: exp.end_date,
                        description: exp.description,
                        location: exp.location
                    })),
                    education: cvData.education.map(edu => ({
                        institution: edu.institution,
                        degree: edu.degree,
                        fieldOfStudy: edu.field_of_study,
                        startDate: edu.start_date,
                        endDate: edu.end_date,
                        grade: edu.grade,
                        description: edu.description
                    })),
                    languages: cvData.languages.map(lang => ({
                        language: lang.language,
                        proficiency: lang.proficiency
                    })),
                    certifications: cvData.certifications.map(cert => ({
                        name: cert.name,
                        issuingOrganization: cert.issuing_organization,
                        issueDate: cert.issue_date,
                        expiryDate: cert.expiry_date,
                        credentialId: cert.credential_id,
                        credentialUrl: cert.credential_url
                    }))
                }
            };
        }
        
        const data = await graphqlQuery(mutation, variables);
        const savedCV = data.updateCv || data.createCv;
        
        if (savedCV) {
            cvData.id = savedCV.id;
            // Update last update time to prevent immediate subscription notification
            if (savedCV.updatedAt) {
                lastUpdateTime = new Date(savedCV.updatedAt).getTime();
            }
            // Update CV ID display
            document.getElementById('cv-id-display').textContent = savedCV.id;
            alert('CV saved successfully!');
        } else {
            alert('Failed to save CV. Please try again.');
        }
    } catch (error) {
        console.error('Error saving CV:', error);
        alert('An error occurred while saving: ' + error.message);
    }
}

function showUpdateNotification() {
    // Create a subtle notification
    const notification = document.createElement('div');
    notification.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50 animate-fade-in';
    notification.innerHTML = `
        <div class="flex items-center space-x-2">
            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
            </svg>
            <span class="text-sm font-medium">CV updated from external source</span>
        </div>
    `;
    
    document.body.appendChild(notification);
    
    // Remove after 3 seconds
    setTimeout(() => {
        notification.remove();
    }, 3000);
}

// Initialize
checkAuth();
updateCVPreview();
</script>

{% endblock %}
